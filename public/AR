<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´¥é—¨è€å­—å· 3D äº¤äº’ç½‘é¡µç³»ç»Ÿ - 1928</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥å¤å¤å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --retro-gold: #d4af37;
            --retro-red: #8a1c1c;
            --retro-dark: #1a1a1a;
        }

        html, body { 
            margin: 0; 
            overflow: hidden; 
            height: 100%; 
            width: 100%; 
            background-color: #0f1115;
            color: #e5e5e5;
        }
        
        /* å­—ä½“ */
        .font-title { font-family: 'Ma Shan Zheng', cursive; }
        .font-body { font-family: 'Noto Serif SC', serif; }

        /* ç•Œé¢æš—è§’ä¸å™ªç‚¹æ•ˆæœ - è¥é€ èƒ¶ç‰‡æ„Ÿ */
        .vignette {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.9) 100%);
            pointer-events: none;
            z-index: 5;
        }
        .noise {
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 4;
            opacity: 0.4;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            width: 60px; height: 60px;
            border: 4px solid var(--retro-gold);
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ¨¡æ€æ¡†è¿›å…¥åŠ¨ç”» */
        #modal-content {
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .modal-open #modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* æµ®åŠ¨æç¤º */
        #floating-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1rem 2rem;
            background: rgba(44, 44, 44, 0.9);
            color: var(--retro-gold);
            border: 2px solid var(--retro-gold);
            border-radius: 8px;
            font-family: 'Noto Serif SC', serif;
            font-size: 1.2rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 30;
        }
    </style>
</head>
<body>

    <!-- 3D å®¹å™¨ -->
    <div id="canvas-container" class="absolute inset-0 z-0"></div>

    <!-- è§†è§‰æ»¤é•œå±‚ -->
    <div class="vignette"></div>
    <div class="noise"></div>

    <!-- UI å±‚ -->
    <div id="ui-layer" class="absolute inset-0 pointer-events-none z-20 flex flex-col justify-between p-6">
        
        <!-- å·¦ä¸Šè§’æ ‡é¢˜ -->
        <div class="pointer-events-auto transition-transform hover:translate-x-1 duration-300">
            <div class="flex items-center space-x-3">
                <div class="w-1 h-12 bg-yellow-600 shadow-[0_0_10px_#d4af37]"></div>
                <div>
                    <h1 class="text-4xl font-title text-yellow-500 tracking-widest drop-shadow-lg">åŠä¸šåœº</h1>
                    <p class="text-xs text-gray-400 font-body tracking-[0.2em] uppercase">Tianjin Grand Bazaar Â· 1928</p>
                </div>
            </div>
        </div>

        <!-- å³ä¸Šè§’åœ°å›¾æŒ‰é’® -->
        <div class="absolute top-6 right-6 pointer-events-auto">
            <button id="map-toggle-btn" class="bg-[#d4af37] text-[#1a1a1a] px-4 py-2 font-title text-lg hover:bg-[#e6c24b] transition shadow-lg border-2 border-[#5c4033]">
                ğŸ—ºï¸ å¤©æ´¥è€å­—å·å†å²åœ°å›¾
            </button>
        </div>

        <!-- å³ä¸‹è§’æ“ä½œæç¤º -->
        <div class="self-end text-right pointer-events-auto">
            <div class="bg-black/40 backdrop-blur-sm border border-white/10 p-4 rounded-lg">
                <p class="text-xs text-yellow-500/80 font-body mb-2 border-b border-white/10 pb-1">äº¤äº’æŒ‡å—</p>
                <div class="text-xs text-gray-300 space-y-1 font-sans">
                    <p>ğŸ–±ï¸ å·¦é”®ç‚¹å‡» <span class="text-yellow-400">éœ“è™¹æ‹›ç‰Œ</span></p>
                    <p>ğŸ–ï¸ æ‹–æ‹½æ—‹è½¬è§†è§’</p>
                    <p>ğŸ” æ»šè½®ç¼©æ”¾åœºæ™¯</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æµ®åŠ¨æç¤ºä¿¡æ¯ (ç”¨äºè€è¾¹é¥ºå­) -->
    <div id="floating-message" class="hidden"></div>

    <!-- åŠ è½½å±å¹• -->
    <div id="loading-screen" class="absolute inset-0 bg-[#0f1115] z-50 flex flex-col items-center justify-center transition-opacity duration-1000 pointer-events-auto">
        <div class="loading-spinner mb-6"></div>
        <h2 class="text-2xl font-title text-yellow-600 tracking-widest">æ´¥é—¨å¤œè‰²</h2>
        <p class="text-gray-500 text-xs mt-2 font-mono uppercase tracking-wide">Initializing 3D Environment...</p>
    </div>

    <!-- è°ƒè¯•æ—¥å¿— (éšè—) -->
    <div id="debug-console" class="hidden fixed bottom-0 left-0 w-full max-h-32 bg-black/80 text-green-400 font-mono text-xs p-2 overflow-y-auto z-50 pointer-events-none"></div>

    <!-- æ¨¡æ€æ¡†ï¼šç‹—ä¸ç† -->
    <div id="modal-goubuli" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300 pointer-events-auto">
        <!-- çº¸è´¨é£æ ¼å¡ç‰‡ -->
        <div id="modal-content" class="relative w-full max-w-2xl bg-[#e8e0d0] text-[#2c2c2c] rounded-sm shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden flex flex-col md:flex-row border-8 border-double border-[#5c4033]">
            
            <!-- å…³é—­æŒ‰é’® -->
            <button id="btn-close" class="absolute top-2 right-2 z-10 w-8 h-8 flex items-center justify-center bg-[#8a1c1c] text-white rounded-full hover:bg-red-700 transition shadow-md">
                âœ•
            </button>

            <!-- å·¦ä¾§ï¼šå›¾ç‰‡ä¸å°ç«  -->
            <div class="md:w-5/12 bg-[#2c2c2c] relative overflow-hidden">
                <img src="https://placehold.co/400x600/2c2c2c/d4af37?text=Goubuli" class="w-full h-full object-cover opacity-80" alt="ç‹—ä¸ç†åŒ…å­">
                <div class="absolute bottom-4 left-4 border-2 border-[#d4af37] p-2 text-[#d4af37]">
                    <p class="font-title text-2xl" style="writing-mode: vertical-rl;">éé—ç¾é£Ÿ</p>
                </div>
                <!-- è£…é¥°æ€§å°ç«  -->
                <div class="absolute top-4 right-4 w-12 h-12 border-2 border-red-800 rounded-sm flex items-center justify-center rotate-12 opacity-80">
                    <span class="text-red-800 font-title text-xs">è€å­—å·</span>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå†…å®¹ -->
            <div class="md:w-7/12 p-8 flex flex-col justify-between bg-[url('https://www.transparenttextures.com/patterns/cream-paper.png')]">
                <div>
                    <h2 class="text-4xl font-title text-[#8a1c1c] mb-2">ç‹—ä¸ç†åŒ…å­</h2>
                    <p class="text-xs text-gray-600 italic mb-6">Go Believe Steamed Buns Â· Since 1858</p>
                    
                    <div class="space-y-4 font-body text-sm leading-relaxed text-gray-800">
                        <p>
                            <span class="font-bold text-[#8a1c1c]">ã€å·¥è‰ºã€‘</span> 
                            é‡‡ç”¨â€œåŠå‘é¢ï¼Œæ°´æ‰“é¦…â€æŠ€è‰ºã€‚é¢çš®æŸ”è½¯è€Œæœ‰åš¼åŠ²ï¼Œé¦…æ–™æ±¤æ±ä¸°ç›ˆã€‚
                        </p>
                        <p>
                            <span class="font-bold text-[#8a1c1c]">ã€ç‰¹è‰²ã€‘</span> 
                            æ¯ä¸ªåŒ…å­ä¸å°‘äºåå…«ä¸ªè¤¶ï¼Œè¤¶èŠ±åŒ€ç§°ï¼Œå½¢ä¼¼ç™½èŠã€‚
                        </p>
                    </div>
                </div>

                <div class="mt-8 border-t-2 border-[#5c4033] pt-4 flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500">ä»Šæ—¥æŒ‚ç‰Œä»·</p>
                        <p class="text-3xl font-bold text-[#8a1c1c] font-body">Â¥ 38.00 <span class="text-sm font-normal">/ ç¬¼</span></p>
                    </div>
                    <button class="bg-[#8a1c1c] text-[#e8e0d0] px-6 py-2 font-title text-lg hover:bg-[#a62828] transition shadow-lg border-2 border-[#5c4033]">
                        åŠ å…¥é£Ÿå•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤©æ´¥è€å­—å·å†å²åœ°å›¾ -->
    <div id="map-container" class="hidden absolute inset-0 bg-[#1a1a1a] z-40 pointer-events-auto">
        <!-- åœ°å›¾å¤´éƒ¨ -->
        <div class="absolute top-0 left-0 right-0 bg-[#1a1a1a] border-b-2 border-[#d4af37] p-4 z-50 flex items-center justify-between">
            <h2 class="text-3xl font-title text-[#d4af37] tracking-widest">å¤©æ´¥è€å­—å·å†å²åœ°å›¾</h2>
            <button id="map-close-btn" class="bg-[#8a1c1c] text-white px-4 py-2 font-title text-lg hover:bg-[#a62828] transition shadow-lg border-2 border-[#5c4033]">
                âœ• å…³é—­åœ°å›¾
            </button>
        </div>
        
        <!-- åœ°å›¾ä¸»åŒºåŸŸ -->
        <div id="historical-map" class="absolute inset-0 mt-16 mb-12 p-4">
            <!-- åœ°å›¾å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
            <div id="map-content" class="w-full h-full bg-[#2c2c2c] rounded-lg border-2 border-[#d4af37] overflow-hidden relative">
                <!-- åœ°å›¾ç¼©æ”¾æ§åˆ¶ -->
                <div class="absolute top-4 right-4 bg-[#1a1a1a] border border-[#d4af37] p-2 rounded-lg space-y-2">
                    <button id="map-zoom-in" class="w-10 h-10 bg-[#d4af37] text-[#1a1a1a] font-bold hover:bg-[#e6c24b] transition">+</button>
                    <button id="map-zoom-out" class="w-10 h-10 bg-[#d4af37] text-[#1a1a1a] font-bold hover:bg-[#e6c24b] transition">-</button>
                </div>
                
                <!-- åœ°å›¾åˆ†ç±»ç­›é€‰ -->
                <div class="absolute bottom-4 left-4 bg-[#1a1a1a] border border-[#d4af37] p-3 rounded-lg">
                    <h3 class="text-sm font-title text-[#d4af37] mb-2">åˆ†ç±»ç­›é€‰</h3>
                    <div class="flex flex-wrap gap-2">
                        <button class="map-category-btn bg-[#d4af37] text-[#1a1a1a] px-3 py-1 text-sm hover:bg-[#e6c24b] transition rounded" data-category="all">å…¨éƒ¨</button>
                        <button class="map-category-btn bg-[#333] text-white px-3 py-1 text-sm hover:bg-[#d4af37] hover:text-[#1a1a1a] transition rounded" data-category="food">é¤é¥®ç¾é£Ÿ</button>
                        <button class="map-category-btn bg-[#333] text-white px-3 py-1 text-sm hover:bg-[#d4af37] hover:text-[#1a1a1a] transition rounded" data-category="retail">é›¶å”®ç™¾è´§</button>
                        <button class="map-category-btn bg-[#333] text-white px-3 py-1 text-sm hover:bg-[#d4af37] hover:text-[#1a1a1a] transition rounded" data-category="craft">æ‰‹å·¥è‰º</button>
                    </div>
                </div>
                
                <!-- åœ°å›¾æ ‡è®°ç‚¹å°†åŠ¨æ€ç”Ÿæˆ -->
                <div id="map-markers" class="absolute inset-0"></div>
                
                <!-- è€å­—å·ä¿¡æ¯é¢æ¿ -->
                <div id="map-info-panel" class="hidden absolute top-4 left-4 bg-[#e8e0d0] text-[#2c2c2c] p-4 rounded-lg shadow-lg w-80 border-2 border-[#5c4033]">
                    <h3 id="info-name" class="text-2xl font-title text-[#8a1c1c] mb-2"></h3>
                    <p id="info-category" class="text-sm text-gray-600 italic mb-3"></p>
                    <div id="info-content" class="text-sm space-y-2 font-body"></div>
                    <div id="info-footer" class="mt-4 pt-3 border-t-2 border-[#5c4033] flex justify-between items-center">
                        <p id="info-address" class="text-xs text-gray-500"></p>
                        <button id="info-close" class="text-xs bg-[#8a1c1c] text-[#e8e0d0] px-3 py-1 hover:bg-[#a62828] transition rounded">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åœ°å›¾åº•éƒ¨ä¿¡æ¯ -->
        <div class="absolute bottom-0 left-0 right-0 bg-[#1a1a1a] border-t-2 border-[#d4af37] p-3 z-50">
            <p class="text-center text-xs text-[#d4af37] font-body">æ•°æ®æ¥æºï¼šå¤©æ´¥å¸‚æ¡£æ¡ˆé¦† | 1928å¹´å¤©æ´¥å•†ä¸šåœ°å›¾</p>
        </div>
    </div>

    <!-- JS é€»è¾‘ -->
    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js';

        // è°ƒè¯•å·¥å…·
        const debugConsole = document.getElementById('debug-console');
        function log(msg, isError = false) {
            console.log(msg);
            if (isError) {
                debugConsole.innerHTML += `<div class="text-red-500">> ${msg}</div>`;
                debugConsole.classList.remove('hidden');
            }
        }
        window.onerror = (e) => log(e, true);

        // æ ¸å¿ƒå˜é‡
        let scene, camera, renderer, controls;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let clock = new THREE.Clock();
        
        // äº¤äº’å¯¹è±¡åˆ—è¡¨
        let interactables = [];
        let hoverObject = null; // å½“å‰é¼ æ ‡æ‚¬åœçš„å¯¹è±¡

        // åŠ¨ç”»å¯¹è±¡
        let mahuaGroup;
        let isMahuaAnimating = false;

        init();
        animate();

        function init() {
            try {
                const container = document.getElementById('canvas-container');

                // 1. åœºæ™¯
                scene = new THREE.Scene();
                // é›¾æ°”ï¼šèŒƒå›´æ‰©å¤§ï¼Œæµ“åº¦ç•¥é™
                scene.fog = new THREE.FogExp2(0x0f1115, 0.015);

                // 2. ç›¸æœº
                camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 400); // Far plane increased
                camera.position.set(18, 8, 25); // æ›´è¿œçš„åˆå§‹è§†è§’
                
                // 3. æ¸²æŸ“å™¨
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.physicallyCorrectLights = true;
                renderer.toneMapping = THREE.ReinhardToneMapping;
                renderer.toneMappingExposure = 2.5;
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                container.appendChild(renderer.domElement);

                // 4. ç¯å…‰
                setupLighting();

                // 5. å»ºç­‘ç¯å¢ƒ
                createCornerBuilding(); // ä¸»æ¥¼
                createBackgroundBuildings(); // èƒŒæ™¯æ¥¼
                createStreetElements(); // è¡—é“

                // 6. æ§åˆ¶å™¨
                controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.minDistance = 10;
                controls.maxDistance = 50;
                controls.maxPolarAngle = Math.PI / 2 - 0.05;
                controls.target.set(0, 4, 0);

                // 7. äº‹ä»¶
                window.addEventListener('resize', onWindowResize);
                window.addEventListener('pointermove', onPointerMove);
                window.addEventListener('click', onClick);

                // éšè—åŠ è½½
                setTimeout(() => {
                    document.getElementById('loading-screen').style.opacity = '0';
                    setTimeout(() => document.getElementById('loading-screen').remove(), 1000);
                }, 1000);

            } catch (err) {
                log(`Init Error: ${err.message}`, true);
            }
        }

        function setupLighting() {
            // æœˆå…‰ï¼ˆå†·è‰²ï¼Œä¸»å…‰ï¼‰
            const moonLight = new THREE.DirectionalLight(0x4a6fa5, 1);
            moonLight.position.set(-20, 30, -20);
            moonLight.castShadow = true;
            // æ‰©å¤§é˜´å½±èŒƒå›´
            moonLight.shadow.camera.left = -40;
            moonLight.shadow.camera.right = 40;
            moonLight.shadow.camera.top = 40;
            moonLight.shadow.camera.bottom = -40;
            moonLight.shadow.mapSize.width = 2048;
            moonLight.shadow.mapSize.height = 2048;
            scene.add(moonLight);

            // è¡—é“ç¯å¢ƒå…‰
            const ambient = new THREE.AmbientLight(0x222222, 0.4);
            scene.add(ambient);
            
            // æ‰¹é‡åˆ›å»ºæš–è‰²è¡—ç¯
            const lampPositions = [
                {x: -15, z: 15}, {x: 15, z: 15},
                {x: -10, z: -10}, {x: 10, z: -10},
                {x: -25, z: 5}, {x: 25, z: 5},
            ];

            const lampMat = new THREE.MeshBasicMaterial({ color: 0xffaa00, emissive: 0xffaa00 });

            lampPositions.forEach(pos => {
                const bulbLight = new THREE.PointLight(0xffaa55, 8, 15, 2); // å¼ºåº¦å¢åŠ 
                bulbLight.position.set(pos.x, 7, pos.z);
                bulbLight.castShadow = true;
                scene.add(bulbLight);

                // ç®€å•çš„ç¯æ³¡æ¨¡å‹
                const bulb = new THREE.Mesh(new THREE.SphereGeometry(0.2), lampMat);
                bulb.position.set(pos.x, 7, pos.z);
                scene.add(bulb);
            });
        }

        // åˆ›å»ºè½¬è§’å»ºç­‘ (åŠä¸šåœº)
        function createCornerBuilding() {
            const buildingGroup = new THREE.Group();

            // æè´¨
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x8c8c8c, roughness: 0.7 });
            const trimMat = new THREE.MeshStandardMaterial({ color: 0xd4af37, roughness: 0.4, metalness: 0.6 });
            
            // --- 1. è½¬è§’åœ†å¡” (Corner Tower) ---
            const towerGeo = new THREE.CylinderGeometry(2.5, 2.5, 15, 16, 1, true, 0, Math.PI/2);
            const tower = new THREE.Mesh(towerGeo, wallMat);
            tower.position.set(0, 7.5, 0);
            tower.rotation.y = Math.PI / 4;
            tower.castShadow = true;
            buildingGroup.add(tower);

            // å¡”é¡¶ç©¹é¡¶
            const domeGeo = new THREE.SphereGeometry(2.5, 16, 16, 0, Math.PI * 2, 0, Math.PI/2);
            const dome = new THREE.Mesh(domeGeo, new THREE.MeshStandardMaterial({ color: 0x2d3436, roughness: 0.5 }));
            dome.position.set(0, 15, 0);
            dome.castShadow = true;
            buildingGroup.add(dome);
            
            // å¡”å°–
            const spire = new THREE.Mesh(new THREE.ConeGeometry(0.3, 4, 8), trimMat);
            spire.position.set(0, 17, 0);
            buildingGroup.add(spire);

            // --- 2. ä¸¤ä¾§ç¿¼æ¥¼ (Wings) ---
            const leftWing = createWing(10, 12, 0);
            leftWing.position.set(-6, 6, -1.5);
            leftWing.rotation.y = -Math.PI / 6;
            buildingGroup.add(leftWing);

            const rightWing = createWing(10, 12, 0);
            rightWing.position.set(6, 6, -1.5);
            rightWing.rotation.y = Math.PI / 6;
            buildingGroup.add(rightWing);
            
            // --- 3. æ‹›ç‰Œä¸äº¤äº’ç‰© ---
            createSignage(buildingGroup);
            scene.add(buildingGroup);
        }

        // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºä¾§ç¿¼æ¥¼ (ç”¨äºä¸»æ¥¼)
        function createWing(width, height, depth) {
            const group = new THREE.Group();
            
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x7f8c8d });
            const wallGeo = new THREE.BoxGeometry(width, height, 3);
            const wall = new THREE.Mesh(wallGeo, wallMat);
            wall.castShadow = true;
            wall.receiveShadow = true;
            group.add(wall);

            // çª—æˆ·é˜µåˆ—
            const winGeo = new THREE.PlaneGeometry(1.2, 2);
            // çª—æˆ·å‘å…‰ï¼Œæ¨¡æ‹Ÿå®¤å†…ç¯å…‰
            const winMat = new THREE.MeshStandardMaterial({ color: 0x000, emissive: 0xffeeaa, emissiveIntensity: 0.8 }); 
            
            for(let i=-3; i<=3; i+=2) {
                // ä¸€å±‚
                const w1 = new THREE.Mesh(winGeo, winMat); w1.position.set(i * 1.5, -3, 1.51); group.add(w1);
                // äºŒå±‚
                const w2 = new THREE.Mesh(winGeo, winMat); w2.position.set(i * 1.5, 0, 1.51); group.add(w2);
                // ä¸‰å±‚
                const w3 = new THREE.Mesh(winGeo, winMat); w3.position.set(i * 1.5, 3, 1.51); group.add(w3);
            }

            return group;
        }
        
        // åˆ›å»ºèƒŒæ™¯å»ºç­‘ç¾¤ (æ‰©å¤§åœºæ™¯)
        function createBackgroundBuildings() {
            const backMat = new THREE.MeshStandardMaterial({ color: 0x444444, roughness: 0.9 });
            const darkWinMat = new THREE.MeshBasicMaterial({ color: 0x0a0a0a });
            const lightWinMat = new THREE.MeshBasicMaterial({ color: 0x555500, emissive: 0x555500, emissiveIntensity: 0.5 });

            // è¿œå¤„èƒŒæ™¯å»ºç­‘
            const positions = [
                {x: -30, z: -15, h: 18, w: 10, d: 8},
                {x: -40, z: 10, h: 14, w: 15, d: 5},
                {x: 35, z: -20, h: 22, w: 12, d: 7},
                {x: 45, z: 15, h: 16, w: 18, d: 6}
            ];

            positions.forEach(({x, z, h, w, d}, index) => {
                const geo = new THREE.BoxGeometry(w, h, d);
                const building = new THREE.Mesh(geo, backMat);
                building.position.set(x, h/2, z);
                building.receiveShadow = true;
                building.castShadow = true;
                scene.add(building);
                
                // æ·»åŠ çª—æˆ·ç»†èŠ‚ (éšæœºç‚¹äº®)
                for(let i = -w/2 + 1; i < w/2 - 1; i += 2) {
                    for(let j = -h/2 + 2; j < h/2 - 1; j += 3) {
                        const win = new THREE.Mesh(
                            new THREE.BoxGeometry(1.5, 2, 0.1),
                            Math.random() > 0.3 ? lightWinMat : darkWinMat
                        );
                        win.position.set(i, j, d/2 + 0.05);
                        building.add(win);
                    }
                }
                
                // æ·»åŠ è€è¾¹é¥ºå­æ‹›ç‰Œåœ¨å·¦ä¾§å»ºç­‘ä¸Š
                if (index === 1) {
                    const lbGeo = new THREE.BoxGeometry(6, 1.5, 0.3);
                    const lbMat = new THREE.MeshStandardMaterial({ 
                        color: 0x009900, // ç»¿è‰²æ‹›ç‰Œ
                        emissive: 0x00ff00, 
                        emissiveIntensity: 1.5 
                    });
                    const laobianSign = new THREE.Mesh(lbGeo, lbMat);
                    laobianSign.position.set(x + w/2 + 0.15, 8, z); // æŒ‚åœ¨ä¾§é¢
                    laobianSign.rotation.y = Math.PI/2;
                    laobianSign.name = "LAOBIAN";
                    laobianSign.castShadow = true;
                    scene.add(laobianSign);
                    interactables.push(laobianSign);
                }
            });
        }

        // åˆ›å»ºè¡—é“å…ƒç´  (åœ°é¢ã€ç¯æŸ±ã€äº¤äº’ç‰©)
        function createStreetElements() {
            // åœ°é¢ - æ¹¿æ¶¦åå…‰è·¯é¢ (å°ºå¯¸åŠ å¤§)
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(200, 200),
                new THREE.MeshStandardMaterial({ 
                    color: 0x050505, 
                    roughness: 0.1, 
                    metalness: 0.3 
                })
            );
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // ç®€å•çš„è·¯ç¯æŸ±
            const lampMat = new THREE.MeshStandardMaterial({ color: 0x1c1c1c });
            
            const streetLampPositions = [
                {x: -8, z: 8}, {x: 8, z: 8},
                {x: -20, z: 20}, {x: 20, z: 20}
            ];
            
            streetLampPositions.forEach(pos => {
                const lamp = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.15, 6, 8), lampMat);
                lamp.position.set(pos.x, 3, pos.z);
                scene.add(lamp);
                
                const bracket = new THREE.Mesh(new THREE.BoxGeometry(2, 0.1, 0.1), lampMat);
                bracket.position.set(pos.x + 1, 6.5, pos.z);
                scene.add(bracket);
                
                // ä»…åˆ›å»ºæ¨¡å‹ï¼Œç¯å…‰å·²åœ¨ setupLighting ä¸­åˆ›å»º
            });
        }

        // åˆ›å»ºæ‹›ç‰Œä¸äº¤äº’ç‰©
        function createSignage(parent) {
            // 1. ç‹—ä¸ç† (ç«–å‘éœ“è™¹ç¯ç‰Œ)
            const signGroup = new THREE.Group();
            signGroup.position.set(-6, 7.5, 4.5);
            signGroup.rotation.y = -Math.PI / 8;
            
            const board = new THREE.Mesh(
                new THREE.BoxGeometry(1.2, 5, 0.2),
                new THREE.MeshStandardMaterial({ color: 0x330000 })
            );
            signGroup.add(board);

            const glowMat = new THREE.MeshStandardMaterial({ 
                color: 0xff3300, 
                emissive: 0xff0000, 
                emissiveIntensity: 2 
            });
            const textBlock = new THREE.Mesh(new THREE.BoxGeometry(0.8, 4.5, 0.05), glowMat);
            textBlock.position.z = 0.1;
            textBlock.name = "GOUBULI";
            signGroup.add(textBlock);
            scene.add(signGroup);
            interactables.push(textBlock);

            // 2. æ¡‚å‘ç¥¥ (æ¨ªå¹…å¹Œå­)
            const bannerGroup = new THREE.Group();
            bannerGroup.position.set(5.5, 6, 4.5);
            bannerGroup.rotation.y = Math.PI / 8;

            const clothGeo = new THREE.BoxGeometry(3, 4, 0.1);
            const clothMat = new THREE.MeshStandardMaterial({ color: 0xb8860b });
            const banner = new THREE.Mesh(clothGeo, clothMat);
            banner.name = "GUIFAXIAN";
            bannerGroup.add(banner);
            
            scene.add(bannerGroup);
            interactables.push(banner);

            // 3. éº»èŠ±æ¨¡å‹ (éšè—)
            mahuaGroup = new THREE.Group();
            const twistGeo = new THREE.TorusKnotGeometry(0.6, 0.2, 100, 16);
            const pastryMat = new THREE.MeshStandardMaterial({ 
                color: 0xd4af37, 
                roughness: 0.4, 
                emissive: 0xaa6600,
                emissiveIntensity: 0.2
            });
            const twist = new THREE.Mesh(twistGeo, pastryMat);
            mahuaGroup.add(twist);
            
            const particleGeo = new THREE.BufferGeometry();
            const count = 50;
            const positions = new Float32Array(count * 3);
            for(let i=0; i<count*3; i++) positions[i] = (Math.random() - 0.5) * 3;
            particleGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const particles = new THREE.Points(particleGeo, new THREE.PointsMaterial({color: 0xffd700, size: 0.1}));
            mahuaGroup.add(particles);

            mahuaGroup.position.set(4, 3, 4);
            mahuaGroup.scale.set(0, 0, 0);
            scene.add(mahuaGroup);
        }

        // äº¤äº’é€»è¾‘
        function onPointerMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(interactables, true);

            if (intersects.length > 0) {
                const obj = intersects[0].object;
                if (hoverObject !== obj) {
                    document.body.style.cursor = 'pointer';
                    hoverObject = obj;
                }
            } else {
                if (hoverObject) {
                    document.body.style.cursor = 'default';
                    hoverObject = null;
                }
            }
        }

        function onClick() {
            if (hoverObject) {
                const name = hoverObject.name;
                if (name === "GOUBULI") {
                    openModal();
                } else if (name === "GUIFAXIAN") {
                    triggerMahuaEffect();
                } else if (name === "LAOBIAN") {
                    showFloatingMessage("è€è¾¹é¥ºå­ï¼šç™¾å¹´ä¼ æ‰¿ï¼Œçš®è–„é¦…å¤§ï¼");
                }
            }
        }

        // æ¨¡æ€æ¡†é€»è¾‘
        const modal = document.getElementById('modal-goubuli');
        const closeBtn = document.getElementById('btn-close');

        function openModal() {
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('modal-open'), 10);
        }
        function closeModal() {
            modal.classList.remove('modal-open');
            setTimeout(() => modal.classList.add('hidden'), 500);
        }
        closeBtn.onclick = closeModal;
        modal.onclick = (e) => { if(e.target === modal) closeModal(); }
        
        // æµ®åŠ¨æ¶ˆæ¯é€»è¾‘
        const floatMsg = document.getElementById('floating-message');
        function showFloatingMessage(message) {
            floatMsg.textContent = message;
            floatMsg.classList.remove('hidden');
            floatMsg.style.opacity = '1';
            floatMsg.style.transform = 'translate(-50%, -60%)'; // å‘ä¸Šå¾®ç§»

            setTimeout(() => {
                floatMsg.style.opacity = '0';
                floatMsg.style.transform = 'translate(-50%, -50%)';
                setTimeout(() => floatMsg.classList.add('hidden'), 300);
            }, 2000);
        }

        // éº»èŠ±ç‰¹æ•ˆ
        function triggerMahuaEffect() {
            if (isMahuaAnimating) return;
            isMahuaAnimating = true;
            showFloatingMessage("æ¡‚å‘ç¥¥ï¼šåå…«è¡—éº»èŠ±ï¼Œé…¥è„†é¦™ç”œï¼"); // è§¦å‘æ—¶æ˜¾ç¤ºæç¤º

            const start = performance.now();
            const duration = 3000;

            function loop(now) {
                const elapsed = now - start;
                const p = Math.min(elapsed / duration, 1);

                // å¼¹è·³æ”¾å¤§æ—‹è½¬
                const scale = Math.sin(p * Math.PI) * 2;
                mahuaGroup.scale.setScalar(scale);
                mahuaGroup.rotation.y = p * Math.PI * 6;
                mahuaGroup.rotation.z = Math.sin(p * Math.PI * 2) * 0.5;

                if (p < 1) requestAnimationFrame(loop);
                else {
                    isMahuaAnimating = false;
                    mahuaGroup.scale.set(0, 0, 0);
                }
            }
            requestAnimationFrame(loop);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            const t = clock.getElapsedTime();

            // æ‹›ç‰Œæµ®åŠ¨åŠ¨ç”»
            scene.traverse(obj => {
                if (obj.name === 'GOUBULI') {
                    // éœ“è™¹ç¯é—ªçƒ
                    obj.material.emissiveIntensity = 1.5 + Math.sin(t * 10) * 0.5;
                } else if (obj.name === 'LAOBIAN') {
                     // ç»¿è‰²éœ“è™¹ç¯å‘¼å¸æ•ˆæœ
                    obj.material.emissiveIntensity = 1.2 + Math.sin(t * 3) * 0.3;
                }
            });

            controls.update();
            renderer.render(scene, camera);
        }
    </script>

    <!-- å¤©æ´¥è€å­—å·å†å²åœ°å›¾åŠŸèƒ½ -->
    <script>
        // åœ°å›¾æ•°æ®
        const oldBrands = [
            {
                id: 1,
                name: "ç‹—ä¸ç†åŒ…å­",
                category: "food",
                description: "åˆ›å»ºäº1858å¹´ï¼Œå¤©æ´¥ä¼ ç»Ÿç¾é£Ÿä»£è¡¨ï¼Œä»¥çš®è–„é¦…å¤§ã€åå…«è¤¶è‘—ç§°ã€‚",
                address: "åŠä¸šåœºè¥¿è¡—",
                position: { x: 50, y: 50 },
                year: 1858
            },
            {
                id: 2,
                name: "è€è¾¹é¥ºå­",
                category: "food",
                description: "ç™¾å¹´ä¼ æ‰¿ï¼Œçš®è–„é¦…å¤§ï¼Œæ±¤æ±æµ“éƒï¼Œæ˜¯å¤©æ´¥è‘—åçš„é¥ºå­å“ç‰Œã€‚",
                address: "åŠä¸šåœºä¸œè¡—",
                position: { x: 30, y: 60 },
                year: 1829
            },
            {
                id: 3,
                name: "æ¡‚å‘ç¥¥",
                category: "food",
                description: "åå…«è¡—éº»èŠ±ï¼Œé…¥è„†é¦™ç”œï¼Œæ˜¯å¤©æ´¥ä¼ ç»Ÿå°åƒçš„ä»£è¡¨ä¹‹ä¸€ã€‚",
                address: "åŠä¸šåœºå—è¡—",
                position: { x: 60, y: 40 },
                year: 1927
            },
            {
                id: 4,
                name: "åŠä¸šåœº",
                category: "retail",
                description: "å¤©æ´¥å•†ä¸šåœ°æ ‡ï¼Œåˆ›å»ºäº1928å¹´ï¼Œæ˜¯ååŒ—åœ°åŒºæœ€å¤§çš„ç»¼åˆæ€§å•†åœºã€‚",
                address: "å’Œå¹³è·¯ä¸æ»¨æ±Ÿé“äº¤å£",
                position: { x: 50, y: 50 },
                year: 1928
            },
            {
                id: 5,
                name: "è€³æœµçœ¼ç‚¸ç³•",
                category: "food",
                description: "åˆ›å»ºäº1900å¹´ï¼Œå¤–é…¥é‡Œå«©ï¼Œé¦™ç”œå¯å£ï¼Œæ˜¯å¤©æ´¥ä¸‰ç»ä¹‹ä¸€ã€‚",
                address: "å¤§èƒ¡åŒ",
                position: { x: 40, y: 70 },
                year: 1900
            },
            {
                id: 6,
                name: "æ³¥äººå¼ ",
                category: "craft",
                description: "åˆ›å»ºäº1850å¹´ï¼Œä»¥å½©å¡‘è‰ºæœ¯é—»åï¼Œæ˜¯å¤©æ´¥æ°‘é—´è‰ºæœ¯çš„ä»£è¡¨ã€‚",
                address: "å¤æ–‡åŒ–è¡—",
                position: { x: 20, y: 50 },
                year: 1850
            }
        ];

        // åœ°å›¾çŠ¶æ€
        let mapState = {
            zoom: 1,
            selectedCategory: 'all',
            markers: []
        };

        // DOMå…ƒç´ 
        const mapToggleBtn = document.getElementById('map-toggle-btn');
        const mapContainer = document.getElementById('map-container');
        const mapCloseBtn = document.getElementById('map-close-btn');
        const mapZoomIn = document.getElementById('map-zoom-in');
        const mapZoomOut = document.getElementById('map-zoom-out');
        const mapInfoPanel = document.getElementById('map-info-panel');
        const infoCloseBtn = document.getElementById('info-close');
        const markersContainer = document.getElementById('map-markers');

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            renderMap();
            bindEvents();
        }

        // æ¸²æŸ“åœ°å›¾
        function renderMap() {
            markersContainer.innerHTML = '';
            mapState.markers = [];
            
            // ç­›é€‰æ•°æ®
            const filteredBrands = oldBrands.filter(brand => {
                return mapState.selectedCategory === 'all' || brand.category === mapState.selectedCategory;
            });
            
            // åˆ›å»ºæ ‡è®°
            filteredBrands.forEach(brand => {
                const marker = createMarker(brand);
                markersContainer.appendChild(marker);
                mapState.markers.push(marker);
            });
        }

        // åˆ›å»ºæ ‡è®°
        function createMarker(brand) {
            const marker = document.createElement('div');
            marker.className = 'absolute cursor-pointer transition-all duration-300 hover:scale-125';
            marker.style.left = `${brand.position.x}%`;
            marker.style.top = `${brand.position.y}%`;
            marker.style.transform = `translate(-50%, -50%) scale(${mapState.zoom})`;
            
            // æ ‡è®°æ ·å¼
            marker.innerHTML = `
                <div class="relative">
                    <div class="w-6 h-6 rounded-full bg-[#d4af37] border-2 border-[#8a1c1c] shadow-lg flex items-center justify-center text-[#1a1a1a] font-bold text-xs">
                        ${brand.category === 'food' ? 'ğŸœ' : brand.category === 'retail' ? 'ğŸª' : 'ğŸ¨'}
                    </div>
                    <div class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-[#1a1a1a] text-[#d4af37] text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 hover:opacity-100 transition-opacity duration-300">
                        ${brand.name}
                    </div>
                </div>
            `;
            
            // ç‚¹å‡»äº‹ä»¶
            marker.addEventListener('click', () => {
                showBrandInfo(brand);
            });
            
            return marker;
        }

        // æ˜¾ç¤ºå“ç‰Œä¿¡æ¯
        function showBrandInfo(brand) {
            document.getElementById('info-name').textContent = brand.name;
            document.getElementById('info-category').textContent = `${brand.category === 'food' ? 'é¤é¥®ç¾é£Ÿ' : brand.category === 'retail' ? 'é›¶å”®ç™¾è´§' : 'æ‰‹å·¥è‰º'} Â· åˆ›ç«‹äº ${brand.year} å¹´`;
            document.getElementById('info-content').innerHTML = `<p><strong>å†å²æ²¿é©ï¼š</strong>${brand.description}</p>`;
            document.getElementById('info-address').textContent = `åœ°å€ï¼š${brand.address}`;
            
            mapInfoPanel.classList.remove('hidden');
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // åœ°å›¾åˆ‡æ¢
            mapToggleBtn.addEventListener('click', () => {
                mapContainer.classList.remove('hidden');
            });
            
            mapCloseBtn.addEventListener('click', () => {
                mapContainer.classList.add('hidden');
                mapInfoPanel.classList.add('hidden');
            });
            
            // ç¼©æ”¾æ§åˆ¶
            mapZoomIn.addEventListener('click', () => {
                mapState.zoom = Math.min(mapState.zoom + 0.2, 2);
                updateMarkersScale();
            });
            
            mapZoomOut.addEventListener('click', () => {
                mapState.zoom = Math.max(mapState.zoom - 0.2, 0.5);
                updateMarkersScale();
            });
            
            // å…³é—­ä¿¡æ¯é¢æ¿
            infoCloseBtn.addEventListener('click', () => {
                mapInfoPanel.classList.add('hidden');
            });
            
            // åˆ†ç±»ç­›é€‰
            document.querySelectorAll('.map-category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                    document.querySelectorAll('.map-category-btn').forEach(b => {
                        b.className = 'map-category-btn bg-[#333] text-white px-3 py-1 text-sm hover:bg-[#d4af37] hover:text-[#1a1a1a] transition rounded';
                    });
                    
                    // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                    btn.className = 'map-category-btn bg-[#d4af37] text-[#1a1a1a] px-3 py-1 text-sm hover:bg-[#e6c24b] transition rounded';
                    
                    // æ›´æ–°ç­›é€‰
                    mapState.selectedCategory = btn.dataset.category;
                    renderMap();
                });
            });
        }

        // æ›´æ–°æ ‡è®°ç¼©æ”¾
        function updateMarkersScale() {
            mapState.markers.forEach(marker => {
                marker.style.transform = `translate(-50%, -50%) scale(${mapState.zoom})`;
            });
        }

        // åˆå§‹åŒ–åœ°å›¾
        initMap();
    </script>
</body>
</html>