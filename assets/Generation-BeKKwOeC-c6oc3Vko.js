import{aD as ue,aG as pe,C as g,aJ as B,aB as i,aL as xe,aM as he,aI as H,aT as J,c as e,az as E,aC as be,a_ as fe,aK as ve}from"./index-DvRCDgMZ.js";function je(){const{isDark:c}=ue(),P=pe(),[u,C]=g.useState(""),[Y,I]=g.useState(!1),[k,f]=g.useState([]),[O,D]=g.useState(""),[se,M]=g.useState(null),[v,T]=g.useState(""),[A,ie]=g.useState([]),[Z,q]=g.useState(!1),[Q,ne]=g.useState("https://ark-project.tos-cn-beijing.ivolces.com/images/view.jpeg"),[X,le]=g.useState(B.getCurrentModel().id),F=g.useRef(null),L=g.useRef(null),ee=g.useRef(null),[te,oe]=g.useState(null);g.useEffect(()=>{try{const t=new URLSearchParams(P.search),r=t.get("prompt")||"",a=t.get("image")||"",s=t.get("autostart")||"",l=t.get("saveToTutorialId")||"";if(r&&C(r),a&&(f([{script:r?`根据提示生成：${r}`:"教程封面生成视频",image:a,video:""}]),s&&setTimeout(()=>re(0),100)),l){const n=Number(l);Number.isNaN(n)||oe(n)}}catch{}},[P.search]);const re=async t=>{var r,a,s,l,n,o,d,x,$,b,j,z,U;const w=k[t];if(!w||!w.image)return;if(w.image.startsWith("data:")){i.error("首帧为本地数据，需使用可公网访问的图片URL");return}const S=`${u}  --resolution 720p  --duration 5 --camerafixed false`;f(p=>p.map((R,m)=>m===t?{...R,video:"生成中..."}:R));try{const p=await xe({model:"doubao-seedance-1-0-pro-250528",content:[{type:"text",text:S},{type:"image_url",image_url:{url:w.image}}]});if(!p.ok||!((r=p.data)!=null&&r.id)){const h=(p==null?void 0:p.error)||((s=(a=p==null?void 0:p.data)==null?void 0:a.error)==null?void 0:s.code)||"UNKNOWN",y=(p==null?void 0:p.error)==="CONFIG_MISSING"?"服务端未配置 DOUBAO_API_KEY，请在 .env.local 设置后重启":`创建视频任务失败：${h}`;i.error(y),f(N=>N.map((_,W)=>W===t?{..._,video:`视频生成失败：${h}`}:_));return}const R=p.data.id,m=await he(R,{intervalMs:1e4,timeoutMs:6e5});if(!m.ok){const h=(m==null?void 0:m.error)||((n=(l=m==null?void 0:m.data)==null?void 0:l.error)==null?void 0:n.code)||"UNKNOWN",y=(m==null?void 0:m.error)==="CONFIG_MISSING"?"服务端未配置 DOUBAO_API_KEY，请在 .env.local 设置后重启":`查询视频任务失败：${h}`;i.error(y),f(N=>N.map((_,W)=>W===t?{..._,video:`视频生成失败：${h}`}:_));return}const G=(o=m.data)==null?void 0:o.status,V=((x=(d=m.data)==null?void 0:d.content)==null?void 0:x.video_url)||"";if(G==="succeeded"&&V){f(h=>h.map((y,N)=>N===t?{...y,video:V}:y)),i.success("视频生成完成");try{if(te&&V){const h=localStorage.getItem("TUTORIAL_VIDEO_OVERRIDES"),y=h?JSON.parse(h):{};y[te]=V,localStorage.setItem("TUTORIAL_VIDEO_OVERRIDES",JSON.stringify(y)),i.success("已写入教程视频覆盖")}}catch{}}else{const h=((b=($=m.data)==null?void 0:$.error)==null?void 0:b.code)||((z=(j=m.data)==null?void 0:j.error)==null?void 0:z.message)||((U=m.data)==null?void 0:U.status)||"UNKNOWN";i.error(`视频生成失败：${h}`),f(y=>y.map((N,_)=>_===t?{...N,video:`视频生成失败：${h}`}:N))}}catch(p){H.logError(p instanceof Error?p:"SERVER_ERROR",{scope:"generation-video",prompt:u}),i.error("视频生成异常"),f(R=>R.map((m,G)=>G===t?{...m,video:"视频生成失败"}:m))}},ae=async t=>{const r=(t??u).trim();if(!r){i.warning("请输入提示词");return}I(!0);try{const a=await fe({prompt:r,n:3,size:"1024x1024",response_format:"url"});if(!a.ok){H.logError(a.error||"SERVER_ERROR",{scope:"generation",prompt:u}),i.error("生成失败，已回退为占位图"),f([{script:"占位方案A",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20A",video:"方案A视频占位"},{script:"占位方案B",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20B",video:"方案B视频占位"},{script:"占位方案C",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20C",video:"方案C视频占位"}]),I(!1);return}const s=a.data,l=s&&(s.data||s.images||[]);if(!l.length){i.info("接口无返回内容，已提供占位图"),f([{script:"占位方案A",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20A",video:"方案A视频占位"},{script:"占位方案B",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20B",video:"方案B视频占位"},{script:"占位方案C",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20C",video:"方案C视频占位"}]),I(!1);return}const n=l.map((o,d)=>{const x=o.url?o.url:o.b64_json?`data:image/png;base64,${o.b64_json}`:"";return{script:`方案${String.fromCharCode(65+d)}脚本`,image:x,video:""}});f(n),i.success("生成完成")}catch(a){H.logError(a instanceof Error?a:"SERVER_ERROR",{scope:"generation",prompt:u}),i.error("生成异常，已回退为占位图"),f([{script:"占位方案A",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20A",video:"方案A视频占位"},{script:"占位方案B",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20B",video:"方案B视频占位"},{script:"占位方案C",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20C",video:"方案C视频占位"}])}finally{I(!1)}};g.useEffect(()=>{if(k.length===0){const t=u.trim()||"天津文化设计灵感";u.trim()||C(t),ae(t),setTimeout(()=>K(t),300)}},[]);const ce=async t=>{const r=k[t];if(!(r!=null&&r.script)){i.warning("暂无脚本可朗读");return}try{const a=await J.synthesize(r.script,{format:"mp3"});D(a.audioUrl),M(t)}catch(a){i.error((a==null?void 0:a.message)||"朗读失败")}},K=async t=>{const r=(t??u).trim();if(!r){i.warning("请输入提示词");return}q(!0),T("");try{B.setCurrentModel(X);const a=B.generateCreativeDirections(r);ie(a);const s="请用中文分点回答，去除所有 Markdown 标题或装饰符（如###、####、** 等），每点保持简短清晰。",l=(r.match(/[A-Za-z]/g)||[]).length,n=(r.match(/[\u4e00-\u9fa5]/g)||[]).length,o=l>n&&l>0?r:`${s}

${r}`,d=await B.generateResponse(o,{onDelta:b=>T(j=>j+b)});T(b=>d||b);const x=d||v||r,$=await J.synthesize(x,{format:"mp3"});D($.audioUrl),M(null)}catch(a){i.error((a==null?void 0:a.message)||"优化或朗读失败")}finally{q(!1)}},de=async()=>{var t,r,a,s,l;const n=String(Q||"").trim();if(!n){i.warning("请填写可公网访问的图片URL");return}try{const o=await ve.chatCompletions({messages:[{role:"user",content:[{type:"image_url",image_url:{url:n}},{type:"text",text:"图片主要讲了什么?"}]}],max_tokens:512});if(!(o!=null&&o.ok)){const x=(o==null?void 0:o.error)||"SERVER_ERROR";i.error(`调用失败：${x}`);return}const d=((s=(a=(r=(t=o==null?void 0:o.data)==null?void 0:t.choices)==null?void 0:r[0])==null?void 0:a.message)==null?void 0:s.content)||"";T(d||"（无返回内容）"),(l=L.current)==null||l.scrollIntoView({behavior:"smooth",block:"start"}),i.success("豆包多模态问答完成")}catch(o){i.error((o==null?void 0:o.message)||"豆包调用失败，请检查服务端环境变量或网络")}},ge=t=>{const r=String(t||"").split(/\r?\n/),a=[];let s=null;for(const l of r){let n=l.trim();if(n=n.replace(/^#{1,6}\s*/,""),n=n.replace(/^```+\s*/,""),n=n.replace(/^>+\s*/,""),!n)continue;const o=n.match(/^(\d+)\)\s*(.+?)：/)||n.match(/^([一二三四五六七八九十]+)\)\s*(.+?)：/);if(o){s&&a.push(s),s={title:o[2],items:[]};continue}s||(s={title:"说明",items:[]});const d=n.replace(/^[-•]\s*/,"");s.items.push(d)}return s&&a.push(s),a},me=t=>{const r=s=>{const l=s||"";return l.includes("诊断")?"search":l.includes("优化")?"magic":l.includes("步骤")?"list-check":l.includes("参考")||l.includes("风格")?"book-open":"pen-nib"},a=ge(t);return a.length===0?e.jsx("pre",{className:`${c?"bg-gray-800/80 text-gray-100 ring-1 ring-gray-700":"bg-white/80 text-gray-800 ring-1 ring-gray-200"} whitespace-pre-wrap break-words rounded-2xl p-5 leading-relaxed shadow-md backdrop-blur-sm border border-white/40 dark:border-gray-700/40 min-h-24`,children:t}):e.jsx("div",{className:"grid gap-4 md:gap-6",children:a.map((s,l)=>e.jsxs("div",{className:`${c?"bg-gray-900/50 ring-1 ring-gray-700":"bg-white/60 ring-1 ring-gray-200"} rounded-2xl p-5 shadow-lg backdrop-blur-sm border border-white/40 dark:border-gray-700/40`,children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("i",{className:`fas fa-${r(s.title)} mr-2 text-blue-600`}),e.jsx("div",{className:"font-semibold tracking-wide",children:s.title})]})}),e.jsx("div",{className:"h-px w-full bg-gradient-to-r from-indigo-500 via-fuchsia-500 to-cyan-500 mb-3 opacity-60"}),e.jsx("ul",{className:"grid md:grid-cols-2 gap-x-6 gap-y-2",children:s.items.map((n,o)=>{const d=String(n||""),x=/^#{1,6}\s*\d+\)\s*/.test(d)||/^#{1,6}\s*[一二三四五六七八九十]+\)\s*/.test(d),$=d.replace(/^#{1,6}\s*\d+\)\s*/,"").replace(/^#{1,6}\s*[一二三四五六七八九十]+\)\s*/,""),b=d.match(/^\*\*(.+?)\*\*：?(.*)$/),j=!!b,z=j&&(b==null?void 0:b[1])||"",U=j&&(b==null?void 0:b[2])||"",w=!j&&!x?d.match(/^([^：:]+)[:：]\s*(.+)$/):null,S=!j&&!x?d.match(/^(\d+|[一二三四五六七八九十]+)[\.、]\s*(.+)$/):null;return e.jsx("li",{className:x?"md:col-span-2 flex items-center py-1":"flex items-start py-1",children:x?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-angle-right mr-2 text-blue-600"}),e.jsx("span",{className:`${c?"text-gray-100":"text-gray-800"} text-sm font-semibold tracking-wide`,children:$})]}):j?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mt-1 mr-2 h-1.5 w-1.5 rounded-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"}),e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 ring-1 ring-blue-200 mr-2 dark:bg-blue-900/20 dark:text-blue-300 dark:ring-blue-800",children:z}),e.jsx("span",{className:`${c?"text-gray-200":"text-gray-700"} text-sm md:text-base leading-relaxed md:leading-7 break-words max-w-[68ch]`,children:U})]}):w?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mt-1 mr-2 h-1.5 w-1.5 rounded-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"}),e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 ring-1 ring-blue-200 mr-2 dark:bg-blue-900/20 dark:text-blue-300 dark:ring-blue-800",children:w[1]}),e.jsx("span",{className:`${c?"text-gray-200":"text-gray-700"} text-sm md:text-base leading-relaxed md:leading-7 break-words max-w-[68ch]`,children:w[2]})]}):S?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mt-1 mr-2 h-1.5 w-1.5 rounded-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"}),e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 ring-1 ring-gray-300 mr-2 dark:bg-gray-700 dark:text-gray-200 dark:ring-gray-600",children:S[1]}),e.jsx("span",{className:`${c?"text-gray-200":"text-gray-700"} text-sm md:text-base leading-relaxed md:leading-7 break-words max-w-[68ch]`,children:S[2]})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mt-1 mr-2 h-1.5 w-1.5 rounded-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"}),e.jsx("span",{className:`${c?"text-gray-200":"text-gray-700"} text-sm md:text-base leading-relaxed md:leading-7 break-words max-w-[68ch]`,children:d})]})},o)})})]},l))})};return g.useEffect(()=>{var t;(A.length>0||v)&&((t=L.current)==null||t.scrollIntoView({behavior:"smooth",block:"start"}))},[A.length,v]),g.useEffect(()=>{var t;k.length>0&&((t=ee.current)==null||t.scrollIntoView({behavior:"smooth",block:"start"}))},[k.length]),e.jsxs("main",{className:"container mx-auto px-4 py-10",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"AI生成引擎"}),e.jsxs("div",{className:`${c?"bg-gray-800":"bg-white"} rounded-2xl shadow-md p-6 mb-6`,children:[e.jsx("label",{htmlFor:"prompt-input",className:"mb-2 block",children:"Midjourney风格提示"}),e.jsx("input",{id:"prompt-input",name:"prompt",ref:F,value:u,onChange:t=>C(t.target.value),"aria-label":"请输入提示词",className:`${c?"bg-gray-700 text-white focus:ring-offset-gray-800":"bg-gray-50 text-gray-900"} w-full px-4 py-3 rounded-lg border focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2`}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx(E.button,{whileHover:{scale:1.03},type:"button",onClick:()=>ae(),className:"bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed",disabled:Y,children:"生成"}),e.jsx(E.button,{whileHover:{scale:1.03},type:"button",onClick:()=>K(),className:"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed",disabled:Z,children:"优化并朗读"}),e.jsxs("select",{"aria-label":"选择模型",value:X,onChange:t=>le(t.target.value),className:`${c?"bg-gray-700 text-white":"bg-gray-50 text-gray-900"} px-3 py-2 rounded-lg border`,children:[e.jsx("option",{value:"kimi",children:"Kimi"}),e.jsx("option",{value:"doubao",children:"豆包"})]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-3 gap-2 items-center",children:[e.jsx("input",{value:Q,onChange:t=>ne(t.target.value),placeholder:"填写可公网访问的图片URL（用于豆包图片问答）",className:`${c?"bg-gray-700 text-white":"bg-gray-50 text-gray-900"} w-full px-4 py-2 rounded-lg border`}),e.jsx(E.button,{whileHover:{scale:1.03},type:"button",onClick:de,className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2",children:"豆包图片问答"})]}),Y&&e.jsx("div",{role:"status","aria-live":"polite",className:"mt-2 text-sm",children:"生成中，预期小于30秒"}),e.jsxs("div",{ref:L,role:"region","aria-labelledby":"ai-copy-title",className:`mt-4 rounded-2xl p-4 ${c?"bg-gray-800":"bg-white"} block`,children:[e.jsx("h2",{id:"ai-copy-title",className:"font-medium mb-2",children:"AI文案"}),A.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:A.map((t,r)=>e.jsx("button",{onClick:()=>{var a;const s=u?`${u} ${t}`:t;C(s),(a=F.current)==null||a.scrollIntoView({behavior:"smooth",block:"center"}),K(s)},className:`text-xs px-3 py-1 rounded-full border transition-colors ${c?"border-gray-600 text-gray-300 hover:border-gray-500":"border-gray-300 text-gray-700 hover:border-gray-400"}`,children:t},r))}),e.jsx("div",{"aria-live":"polite",className:"text-sm",children:me(v)}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("button",{type:"button","aria-label":"朗读文案",onClick:async()=>{const t=v.trim()?v:u.trim();if(!t){i.warning("请先生成文案或填写提示");return}try{const r=await J.synthesize(t,{format:"mp3"});D(r.audioUrl),M(null)}catch(r){i.error((r==null?void 0:r.message)||"朗读失败")}},className:"text-sm px-3 py-1 rounded-md bg-green-600 text-white",disabled:!v.trim()&&!u.trim(),children:"朗读"}),e.jsx("button",{type:"button","aria-label":"复制文案",onClick:async()=>{const t=v.trim()?v:u.trim();if(!t){i.warning("暂无可复制内容");return}try{await navigator.clipboard.writeText(t),i.success("文案已复制")}catch{i.error("复制失败")}},className:`${c?"bg-gray-700 text-white":"bg-gray-100 text-gray-900"} text-sm px-3 py-1 rounded-md`,children:"复制文案"}),e.jsx("button",{type:"button","aria-label":"应用到提示词",onClick:()=>{var t;const r=v.trim()?v:u.trim();if(!r){i.warning("暂无可应用内容");return}C(r),(t=F.current)==null||t.scrollIntoView({behavior:"smooth",block:"center"})},className:`${c?"bg-gray-700 text-white":"bg-gray-100 text-gray-900"} text-sm px-3 py-1 rounded-md`,children:"应用到提示词"})]}),Z&&e.jsx("div",{role:"status","aria-live":"polite",className:`${c?"text-gray-500":"text-gray-400"} text-xs mt-2`,children:"生成中…"}),O&&e.jsx("audio",{controls:!0,src:O,className:"mt-2 w-full"})]})]}),e.jsx("div",{ref:ee,className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:k.map((t,r)=>e.jsxs("div",{className:`${c?"bg-gray-800":"bg-white"} rounded-2xl shadow-md p-4`,children:[e.jsx(be,{src:t.image,alt:"variant",className:"w-full h-40 object-cover rounded-lg mb-3",ratio:"landscape"}),e.jsx("div",{className:"text-sm mb-2",children:t.script}),e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx(E.button,{whileHover:{scale:1.03},onClick:()=>ce(r),className:"bg-green-600 text-white px-3 py-1 rounded-md",children:"朗读脚本"}),se===r&&O&&e.jsx("audio",{controls:!0,src:O,className:"mt-1 w-full"})]}),t.video&&(t.video.startsWith("http")?e.jsxs("div",{className:`${c?"bg-gray-700":"bg-gray-50"} rounded-lg p-3 text-sm`,children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("a",{href:t.video,target:"_blank",rel:"noreferrer",className:"text-blue-600",children:"打开视频"}),e.jsx("button",{className:`text-xs px-2 py-1 rounded ${c?"bg-gray-600 text-white":"bg-white ring-1 ring-gray-200"}`,onClick:async()=>{try{await navigator.clipboard.writeText(t.video),i.success("链接已复制")}catch{i.error("复制失败")}},children:"复制链接"})]}),e.jsx("video",{controls:!0,src:`/api/proxy/video?url=${encodeURIComponent(t.video)}`,className:"w-full mt-2 rounded"})]}):e.jsx("div",{className:`${c?"bg-gray-700":"bg-gray-50"} rounded-lg p-3 text-sm break-all`,children:t.video})),e.jsx(E.button,{whileHover:{scale:1.03},onClick:()=>re(r),className:"mt-2 bg-blue-600 text-white px-3 py-1 rounded-md",children:"生成视频"})]},r))})]})}export{je as default};
