import{aD as ae,C as r,c as t,az as A,aB as E,b4 as je}from"./index-DvRCDgMZ.js";var ve=Object.defineProperty,Ce=(p,s,l)=>s in p?ve(p,s,{enumerable:!0,configurable:!0,writable:!0,value:l}):p[s]=l,I=(p,s,l)=>Ce(p,typeof s!="symbol"?s+"":s,l);class we{constructor(){I(this,"ws",null),I(this,"callbacks",{}),I(this,"reconnectAttempts",0),I(this,"maxReconnectAttempts",5),I(this,"reconnectDelay",1e3),I(this,"isConnecting",!1),I(this,"heartbeatInterval",null)}connect(s,l,g){var i;if(!(this.isConnecting||((i=this.ws)==null?void 0:i.readyState)===WebSocket.OPEN)){this.isConnecting=!0;try{const c=`ws://localhost:3007/ws?sessionId=${encodeURIComponent(s)}&userId=${encodeURIComponent(l)}&username=${encodeURIComponent(g)}`;this.ws=new WebSocket(c),this.ws.onopen=()=>{var o,d;console.log("WebSocket连接已建立"),this.isConnecting=!1,this.reconnectAttempts=0,this.startHeartbeat(),(d=(o=this.callbacks).onOpen)==null||d.call(o)},this.ws.onclose=o=>{var d,x;console.log("WebSocket连接已关闭",o.code,o.reason),this.isConnecting=!1,this.stopHeartbeat(),(x=(d=this.callbacks).onClose)==null||x.call(d),this.reconnectAttempts<this.maxReconnectAttempts&&setTimeout(()=>{this.reconnectAttempts++,this.connect(s,l,g)},this.reconnectDelay*this.reconnectAttempts)},this.ws.onerror=o=>{var d,x;console.error("WebSocket错误:",o),this.isConnecting=!1,(x=(d=this.callbacks).onError)==null||x.call(d,o)},this.ws.onmessage=o=>{try{const d=JSON.parse(o.data);this.handleMessage(d)}catch(d){console.error("WebSocket消息解析错误:",d)}}}catch(c){console.error("WebSocket连接失败:",c),this.isConnecting=!1}}}disconnect(){this.ws&&(this.ws.close(1e3,"用户主动断开"),this.ws=null),this.stopHeartbeat(),this.isConnecting=!1}send(s){var l;((l=this.ws)==null?void 0:l.readyState)===WebSocket.OPEN?this.ws.send(JSON.stringify(s)):console.warn("WebSocket未连接，无法发送消息")}sendTextEdit(s,l,g="",i=0){this.send({type:"text_edit",operation:s,position:l,text:g,length:i})}sendCursorMove(s){this.send({type:"cursor_move",position:s})}sendSelectionChange(s,l){this.send({type:"selection_change",start:s,end:l})}sendTypingStart(){this.send({type:"typing_start"})}sendTypingStop(){this.send({type:"typing_stop"})}handleMessage(s){var l,g,i,c,o,d,x,k,y,w,f,j,N,R;switch((g=(l=this.callbacks).onMessage)==null||g.call(l,s),s.type){case"session_joined":(c=(i=this.callbacks).onSessionJoin)==null||c.call(i,s);break;case"user_joined":(d=(o=this.callbacks).onUserJoined)==null||d.call(o,s);break;case"user_left":(k=(x=this.callbacks).onUserLeft)==null||k.call(x,s);break;case"text_edit":(w=(y=this.callbacks).onTextEdit)==null||w.call(y,s);break;case"cursor_update":(j=(f=this.callbacks).onCursorUpdate)==null||j.call(f,s);break;case"selection_update":(R=(N=this.callbacks).onSelectionUpdate)==null||R.call(N,s);break;case"error":console.error("WebSocket服务器错误:",s.message);break;default:console.warn("未知的WebSocket消息类型:",s.type)}}startHeartbeat(){this.heartbeatInterval=setInterval(()=>{var s;((s=this.ws)==null?void 0:s.readyState)===WebSocket.OPEN&&this.send({type:"ping"})},3e4)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}setCallbacks(s){this.callbacks={...this.callbacks,...s}}onOpen(s){this.callbacks.onOpen=s}onClose(s){this.callbacks.onClose=s}onError(s){this.callbacks.onError=s}onMessage(s){this.callbacks.onMessage=s}onSessionJoin(s){this.callbacks.onSessionJoin=s}onUserJoined(s){this.callbacks.onUserJoined=s}onUserLeft(s){this.callbacks.onUserLeft=s}onTextEdit(s){this.callbacks.onTextEdit=s}onCursorUpdate(s){this.callbacks.onCursorUpdate=s}onSelectionUpdate(s){this.callbacks.onSelectionUpdate=s}getConnectionState(){var s,l;return this.isConnecting?"connecting":((s=this.ws)==null?void 0:s.readyState)===WebSocket.OPEN?"open":((l=this.ws)==null?void 0:l.readyState)===WebSocket.CLOSED?"closed":"error"}}const m=new we,Ne=je.memo(({sessionId:p,userId:s,username:l,initialContent:g="",readOnly:i=!1,onContentChange:c,className:o=""})=>{const{theme:d,isDark:x}=ae(),[k,y]=r.useState(g),[w,f]=r.useState(!1),[j,N]=r.useState([]),[R,Z]=r.useState([]),[_,q]=r.useState([]),[B,J]=r.useState(!1),[Se,ne]=r.useState(0),[M,re]=r.useState(!1),[b,le]=r.useState([g]),[h,U]=r.useState(0),[G,Q]=r.useState(!1),[V,ee]=r.useState(!1),T=r.useRef(null),L=r.useRef(),W=r.useRef(new Map),H=r.useRef();r.useEffect(()=>{re(!0)},[]);const O=r.useCallback(e=>{if(!W.current.has(e)){const a=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FECA57","#FF9FF3","#54A0FF","#5F27CD","#00D2D3","#FF9F43"],n=a[W.current.size%a.length];W.current.set(e,n)}return W.current.get(e)},[]);r.useEffect(()=>(m.connect(p,s,l),m.onMessage(e=>{ie(e)}),m.onOpen(()=>{f(!0),E.success("协作连接已建立")}),m.onClose(()=>{f(!1),E.error("协作连接已断开")}),m.onError(e=>{console.error("WebSocket错误:",e),E.error("协作连接出现错误")}),()=>{m.disconnect()}),[p,s,l]);const ie=r.useCallback(e=>{switch(e.type){case"text_edit":ce(e);break;case"cursor_move":oe(e);break;case"selection_change":de(e);break;case"user_joined":ue(e);break;case"user_left":xe(e);break;case"typing_start":he(e);break;case"typing_stop":me(e);break}},[]),ce=r.useCallback(e=>{e.userId!==s&&y(a=>{let n=a;return e.operation==="insert"?n=a.slice(0,e.position)+e.text+a.slice(e.position):e.operation==="delete"&&(n=a.slice(0,e.position)+a.slice(e.position+e.length)),c==null||c(n),n!==b[h]&&z(n),n})},[s,c,b,h]),K=r.useCallback(e=>{var a;if(!T.current)return e*8;const n=T.current,u=n.textContent||"";if(e===0)return 0;if(e>=u.length){const $=document.createRange();$.selectNodeContents(n),$.collapse(!1);const X=$.getBoundingClientRect(),ke=n.getBoundingClientRect();return X.left-ke.left}const v=document.createRange();v.selectNodeContents(n),v.setStart(n.firstChild||n,0);let S=0,C=n.firstChild;for(;C&&S<e;){if(C.nodeType===Node.TEXT_NODE){const $=((a=C.textContent)==null?void 0:a.length)||0;if(S+$>=e){const X=e-S;v.setStart(C,X);break}S+=$}C=C.nextSibling}const F=v.getBoundingClientRect(),Y=n.getBoundingClientRect();return F.left-Y.left},[]),oe=r.useCallback(e=>{e.userId!==s&&N(a=>[...a.filter(n=>n.userId!==e.userId),{userId:e.userId,username:e.username,position:e.position,color:O(e.userId)}])},[s,O]),de=r.useCallback(e=>{e.userId!==s&&Z(a=>{const n=a.filter(u=>u.userId!==e.userId);return e.start!==e.end?[...n,{userId:e.userId,username:e.username,start:e.start,end:e.end,color:O(e.userId)}]:n})},[s,O]),ue=r.useCallback(e=>{E.info(`${e.username} 加入了协作`)},[]),xe=r.useCallback(e=>{E.info(`${e.username} 离开了协作`),N(a=>a.filter(n=>n.userId!==e.userId)),Z(a=>a.filter(n=>n.userId!==e.userId))},[]),he=r.useCallback(e=>{e.userId!==s&&q(a=>[...a.filter(n=>n.userId!==e.userId),{userId:e.userId,username:e.username,isTyping:!0}])},[s]),me=r.useCallback(e=>{e.userId!==s&&q(a=>a.filter(n=>n.userId!==e.userId))},[s]),te=r.useCallback(()=>{if(h>0){Q(!0);const e=h-1,a=b[e];y(a),U(e),c==null||c(a),setTimeout(()=>Q(!1),0)}},[b,h,c]),se=r.useCallback(()=>{if(h<b.length-1){ee(!0);const e=h+1,a=b[e];y(a),U(e),c==null||c(a),setTimeout(()=>ee(!1),0)}},[b,h,c]),P=r.useCallback(e=>{i||((e.ctrlKey||e.metaKey)&&e.key==="z"&&(e.preventDefault(),te()),(e.ctrlKey||e.metaKey)&&e.key==="y"&&(e.preventDefault(),se()))},[i,te,se]);r.useEffect(()=>(window.addEventListener("keydown",P),()=>{window.removeEventListener("keydown",P)}),[P]);const z=r.useCallback(e=>{if(G||V)return;const a=b.slice(0,h+1),n=50;a.length>=n&&(a.shift(),U(h-1)),le([...a,e]),U(u=>Math.min(u+1,n-1))},[b,h,G,V]),ge=r.useCallback(e=>{if(i)return;const a=e.target.innerHTML||"";y(a),c==null||c(a),H.current&&clearTimeout(H.current),H.current=setTimeout(()=>{a!==b[h]&&z(a)},500),B||(J(!0),m.sendTypingStart()),ne(Date.now()),L.current&&clearTimeout(L.current),L.current=setTimeout(()=>{J(!1),m.sendTypingStop()},1e3)},[i,c,B,k,b,h,z]),be=r.useCallback(e=>{if(i||!M)return;const a=e.target,n=window.getSelection();if(!n||n.rangeCount===0)return;const u=n.getRangeAt(0),v=D(a,u);if(m.sendCursorMove(v),u.collapsed)m.sendSelectionChange(v,v);else{const S=u.cloneRange();S.collapse(!0);const C=D(a,S),F=u.cloneRange();F.collapse(!1);const Y=D(a,F);m.sendSelectionChange(C,Y)}},[i,M]),D=(e,a)=>{const n=a.cloneRange();return n.selectNodeContents(e),n.setEnd(a.endContainer,a.endOffset),n.toString().length},pe=r.useCallback(()=>{if(i||!T.current||!M)return;const e=window.getSelection();if(!e||e.rangeCount===0)return;const a=e.getRangeAt(0),n=D(T.current,a.cloneRange());a.collapse(!1);const u=D(T.current,a);m.sendSelectionChange(n,u)},[i,M]),ye=()=>j.map(e=>{const a=K(e.position);return t.jsxs("div",{className:"absolute flex flex-col items-center pointer-events-none",style:{left:`${a}px`,top:"0px"},children:[t.jsx("div",{className:"w-0.5 h-5 animate-pulse",style:{backgroundColor:e.color}}),t.jsx("div",{className:"mt-1 px-2 py-0.5 rounded text-xs font-medium text-white shadow-sm",style:{backgroundColor:e.color},children:e.username})]},e.userId)}),fe=()=>R.map(e=>{const a=K(e.start),n=K(e.end),u=Math.abs(n-a);return t.jsx("div",{className:"absolute h-5 opacity-20",style:{left:`${Math.min(a,n)}px`,width:`${u}px`,backgroundColor:e.color,top:"2px"},title:`${e.username}的选择`},e.userId)});return t.jsxs(A.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},className:`relative ${o}`,children:[t.jsxs("div",{className:`flex flex-col mb-3 p-2 rounded-lg text-sm ${x?"bg-gray-800":"bg-gray-100"}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:`w-2 h-2 rounded-full ${w?"bg-green-500":"bg-red-500"} animate-pulse`}),t.jsx("span",{children:w?"协作已连接":"协作已断开"}),t.jsx("span",{className:"text-gray-500",children:"•"}),t.jsxs("span",{children:[j.length+1," 人在线"]})]}),t.jsx("div",{className:"flex items-center space-x-1",children:j.map(e=>t.jsxs(A.div,{className:"flex items-center space-x-1 px-2 py-1 rounded text-xs",style:{backgroundColor:e.color+"20"},initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},transition:{duration:.2},children:[t.jsx("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:e.color}}),t.jsx("span",{children:e.username})]},e.userId))})]}),_.length>0&&t.jsx(A.div,{className:"text-xs text-gray-600 dark:text-gray-300",initial:{opacity:0,y:-5},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},children:_.map(e=>t.jsxs("span",{className:"mr-2",children:[e.username," 正在输入",_.length>1?"...":""]},e.userId))})]}),t.jsxs("div",{className:"relative",children:[t.jsxs("div",{className:"absolute inset-0 pointer-events-none",children:[ye(),fe()]}),t.jsx("div",{ref:T,contentEditable:!i,suppressContentEditableWarning:!0,className:`min-h-[200px] p-4 rounded-lg border-2 focus:outline-none focus:border-red-500 transition-colors ${x?"bg-gray-900 border-gray-700 text-white":"bg-white border-gray-300 text-gray-900"} ${i?"cursor-not-allowed opacity-70":""}`,dangerouslySetInnerHTML:{__html:k},onInput:ge,onKeyDown:be,onMouseUp:pe,onBlur:()=>{B&&(J(!1),m.sendTypingStop())},"aria-label":"协作编辑器","aria-describedby":_.length>0?"typing-status":void 0})]}),t.jsx("div",{className:"mt-2 text-xs text-gray-500",children:!i&&t.jsxs("span",{children:["使用 ",t.jsx("kbd",{className:"px-1 py-0.5 bg-gray-200 dark:bg-gray-700 rounded",children:"Ctrl+Z"})," 撤销，",t.jsx("kbd",{className:"ml-1 px-1 py-0.5 bg-gray-200 dark:bg-gray-700 rounded",children:"Ctrl+Y"})," 重做"]})})]})}),Ee=()=>{const{theme:p,isDark:s}=ae(),[l,g]=r.useState("demo-session-1"),[i,c]=r.useState(`user-${Date.now()}`),[o,d]=r.useState(`用户${Math.floor(Math.random()*1e3)}`),[x,k]=r.useState(`欢迎来到津脉智坊协作编辑器！

这是一个实时协作编辑演示，您可以与其他人同时编辑同一份文档。

功能特性：
• 实时文本同步
• 光标位置共享
• 选择范围可视化
• 用户状态指示
• 输入状态显示`),y=f=>{k(f)},w=()=>{const f=`session-${Date.now()}`,j=`user-${Date.now()}`,N=`用户${Math.floor(Math.random()*1e3)}`;g(f),c(j),d(N),k(`新的协作会话已创建！

开始您的实时协作编辑体验吧！`),E.success("已创建新的协作会话")};return t.jsx(A.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"min-h-screen p-6",style:{backgroundColor:s?"#0f172a":"#f8fafc"},children:t.jsxs("div",{className:"max-w-6xl mx-auto",children:[t.jsxs("div",{className:"text-center mb-8",children:[t.jsx("h1",{className:"text-4xl font-bold mb-4 bg-gradient-to-r from-red-600 to-red-400 bg-clip-text text-transparent",children:"津脉智坊 - 实时协作编辑器"}),t.jsx("p",{className:"text-lg text-gray-600 dark:text-gray-400 mb-6",children:"体验多人实时协作编辑的强大功能"})]}),t.jsx("div",{className:`mb-6 p-4 rounded-lg ${s?"bg-gray-800":"bg-white shadow"} border border-gray-200 dark:border-gray-700`,children:t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[t.jsxs("div",{className:"flex flex-col space-y-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"会话ID:"}),t.jsx("code",{className:"px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-sm",children:l})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"当前用户:"}),t.jsx("span",{className:"px-2 py-1 bg-red-100 dark:bg-red-900 rounded text-sm text-red-800 dark:text-red-200",children:o})]})]}),t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx("button",{onClick:w,className:"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors duration-200 font-medium",children:"创建新会话"}),t.jsx("button",{onClick:()=>{navigator.clipboard.writeText(l),E.success("会话ID已复制到剪贴板")},className:"px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200 font-medium",children:"复制会话ID"})]})]})}),t.jsx("div",{className:`mb-6 rounded-lg overflow-hidden ${s?"bg-gray-800":"bg-white shadow"} border border-gray-200 dark:border-gray-700`,children:t.jsx(Ne,{sessionId:l,userId:i,username:o,initialContent:x,onContentChange:y,className:"w-full"})}),t.jsxs("div",{className:`p-6 rounded-lg ${s?"bg-gray-800":"bg-white shadow"} border border-gray-200 dark:border-gray-700`,children:[t.jsx("h2",{className:"text-2xl font-bold mb-4 text-gray-800 dark:text-white",children:"功能说明"}),t.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx("div",{className:"w-8 h-8 rounded-full bg-red-100 dark:bg-red-900 flex items-center justify-center flex-shrink-0",children:t.jsx("i",{className:"fas fa-users text-red-600 dark:text-red-400"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-gray-800 dark:text-white",children:"实时协作"}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"多人同时编辑同一文档，所有更改实时同步"})]})]}),t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center flex-shrink-0",children:t.jsx("i",{className:"fas fa-mouse-pointer text-blue-600 dark:text-blue-400"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-gray-800 dark:text-white",children:"光标同步"}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"实时显示其他用户的光标位置和选择范围"})]})]})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx("div",{className:"w-8 h-8 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center flex-shrink-0",children:t.jsx("i",{className:"fas fa-bolt text-green-600 dark:text-green-400"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-gray-800 dark:text-white",children:"输入状态"}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"显示其他用户的输入状态，了解协作进度"})]})]}),t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center flex-shrink-0",children:t.jsx("i",{className:"fas fa-shield-alt text-purple-600 dark:text-purple-400"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-gray-800 dark:text-white",children:"稳定连接"}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"自动重连机制，确保协作过程稳定可靠"})]})]})]})]})]}),t.jsx("div",{className:`mt-6 p-4 rounded-lg ${s?"bg-yellow-900/20 border-yellow-800":"bg-yellow-50 border-yellow-200"} border`,children:t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx("i",{className:"fas fa-lightbulb text-yellow-500 mt-1"}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-yellow-800 dark:text-yellow-200",children:"使用提示"}),t.jsxs("ul",{className:"text-sm text-yellow-700 dark:text-yellow-300 mt-1 space-y-1",children:[t.jsx("li",{children:"• 在多个浏览器标签页中打开此页面，模拟多人协作"}),t.jsx("li",{children:"• 复制会话ID分享给其他人，邀请他们加入协作"}),t.jsx("li",{children:"• 观察光标和选择范围的实时同步效果"}),t.jsx("li",{children:"• 尝试同时输入，体验实时同步的流畅性"})]})]})]})})]})})};export{Ee as default};
