import{aD as E,C as h,c as e,az as w,bf as C}from"./index-DvRCDgMZ.js";var D=Object.defineProperty,I=(i,t,r)=>t in i?D(i,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[t]=r,u=(i,t,r)=>I(i,typeof t!="symbol"?t+"":t,r);class O{constructor(){u(this,"POINTS_RECORD_KEY","SECURE_POINTS_RECORDS"),u(this,"pointsRecords",[]),u(this,"currentPoints",0),u(this,"cache",{}),u(this,"CACHE_KEYS",["currentPoints","pointsRecords"]),this.loadPointsRecords(),this.calculateCurrentPoints()}loadPointsRecords(){try{const t=localStorage.getItem(this.POINTS_RECORD_KEY);t?this.pointsRecords=JSON.parse(t):(this.pointsRecords=[{id:1,source:"系统初始化",type:"system",points:0,date:new Date().toISOString().split("T")[0],description:"初始积分",balanceAfter:0}],this.savePointsRecords())}catch(t){console.error("Failed to load points records:",t),this.pointsRecords=[]}}savePointsRecords(){try{localStorage.setItem(this.POINTS_RECORD_KEY,JSON.stringify(this.pointsRecords))}catch(t){console.error("Failed to save points records:",t)}}calculateCurrentPoints(){this.currentPoints=this.pointsRecords.reduce((t,r)=>t+r.points,0),this.cache.currentPoints=this.currentPoints}getCurrentPoints(){return this.cache.currentPoints!==void 0?this.cache.currentPoints:(this.calculateCurrentPoints(),this.currentPoints)}getPointsRecords(t,r=20,a=0){let c=[...this.pointsRecords];if(t&&(t.startDate&&(c=c.filter(o=>o.date>=t.startDate)),t.endDate&&(c=c.filter(o=>o.date<=t.endDate)),t.type&&(c=c.filter(o=>o.type===t.type)),t.search)){const o=t.search.toLowerCase();c=c.filter(n=>n.source.toLowerCase().includes(o)||n.description.toLowerCase().includes(o))}return c.sort((o,n)=>new Date(n.date).getTime()-new Date(o.date).getTime()).slice(a,a+r)}getRecentPointsRecords(t=5){const r=`recentRecords_${t}`;if(this.cache[r])return this.cache[r];const a=this.getPointsRecords(void 0,t);return this.cache[r]=a,a}addPoints(t,r,a,c,o){const n={id:this.pointsRecords.length+1,source:r,type:a,points:t,date:new Date().toISOString().split("T")[0],description:c,relatedId:o,balanceAfter:this.currentPoints+t};return this.pointsRecords.push(n),this.calculateCurrentPoints(),this.savePointsRecords(),this.clearCache(),n}consumePoints(t,r,a,c,o){if(t>this.currentPoints)throw new Error("积分不足");const n={id:this.pointsRecords.length+1,source:r,type:a,points:-t,date:new Date().toISOString().split("T")[0],description:c,relatedId:o,balanceAfter:this.currentPoints-t};return this.pointsRecords.push(n),this.calculateCurrentPoints(),this.savePointsRecords(),this.clearCache(),n}syncWithAchievementService(){C.pointsRecords=this.pointsRecords.map(t=>({id:t.id,source:t.source,type:t.type,points:t.points,date:t.date,description:t.description,relatedId:t.relatedId,balanceAfter:t.balanceAfter}))}getPointsSourceStats(){if(this.cache.pointsSourceStats)return this.cache.pointsSourceStats;const t={achievement:0,task:0,daily:0,consumption:0,exchange:0,other:0};return this.pointsRecords.forEach(r=>{const a=r.type in t?r.type:"other";t[a]+=r.points}),this.cache.pointsSourceStats=t,t}clearCache(t){t?t.forEach(r=>{delete this.cache[r]}):this.CACHE_KEYS.forEach(r=>{delete this.cache[r]})}resetCache(){this.cache={}}}const m=new O;class A{constructor(){u(this,"PRODUCTS_KEY","SECURE_PRODUCTS"),u(this,"EXCHANGE_RECORDS_KEY","SECURE_EXCHANGE_RECORDS"),u(this,"products",[]),u(this,"exchangeRecords",[]),this.loadProducts(),this.loadExchangeRecords()}loadProducts(){try{const t=localStorage.getItem(this.PRODUCTS_KEY);t?this.products=JSON.parse(t):(this.products=[{id:1,name:"虚拟红包",description:"1000积分兑换10元虚拟红包",points:1e3,stock:100,status:"active",category:"virtual",tags:["红包","虚拟"],imageUrl:"/images/红包.svg",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:2,name:"创意贴纸包",description:"500积分兑换创意贴纸包",points:500,stock:50,status:"active",category:"virtual",tags:["贴纸","虚拟"],imageUrl:"/images/贴纸包.svg",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:3,name:"AI创作工具包",description:"2000积分兑换高级AI创作工具包",points:2e3,stock:30,status:"active",category:"service",tags:["AI工具","服务"],imageUrl:"/images/AI工具包.svg",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:4,name:"专属成就徽章",description:"1500积分兑换专属成就徽章",points:1500,stock:100,status:"active",category:"rights",tags:["徽章","权益"],imageUrl:"/images/成就徽章.svg",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:5,name:"实体创意笔记本",description:"3000积分兑换实体创意笔记本",points:3e3,stock:20,status:"active",category:"physical",tags:["笔记本","实体"],imageUrl:"/images/笔记本.svg",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],this.saveProducts())}catch(t){console.error("Failed to load products:",t),this.products=[]}}saveProducts(){try{localStorage.setItem(this.PRODUCTS_KEY,JSON.stringify(this.products))}catch(t){console.error("Failed to save products:",t)}}loadExchangeRecords(){try{const t=localStorage.getItem(this.EXCHANGE_RECORDS_KEY);t?this.exchangeRecords=JSON.parse(t):(this.exchangeRecords=[],this.saveExchangeRecords())}catch(t){console.error("Failed to load exchange records:",t),this.exchangeRecords=[]}}saveExchangeRecords(){try{localStorage.setItem(this.EXCHANGE_RECORDS_KEY,JSON.stringify(this.exchangeRecords))}catch(t){console.error("Failed to save exchange records:",t)}}getAllProducts(){return[...this.products]}getProductById(t){return this.products.find(r=>r.id===t)}getUserExchangeRecords(t="current-user"){return[...this.exchangeRecords].filter(r=>r.userId===t).sort((r,a)=>new Date(a.date).getTime()-new Date(r.date).getTime())}exchangeProduct(t,r="current-user"){const a=this.products.find(o=>o.id===t);if(!a)throw new Error("商品不存在");if(a.status!=="active")throw new Error("商品不可用");if(a.stock<=0)throw new Error("商品已售罄");if(m.getCurrentPoints()<a.points)throw new Error("积分不足");m.consumePoints(a.points,"积分商城","exchange",`兑换商品：${a.name}`,`product_${t}`),a.stock-=1,a.stock===0&&(a.status="sold_out"),a.updatedAt=new Date().toISOString(),this.saveProducts();const c={id:this.exchangeRecords.length+1,productId:a.id,productName:a.name,points:a.points,date:new Date().toISOString(),userId:r,status:"completed"};return this.exchangeRecords.push(c),this.saveExchangeRecords(),c}addProduct(t){const r={...t,id:this.products.length+1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return this.products.push(r),this.saveProducts(),r}updateProduct(t,r){const a=this.products.findIndex(o=>o.id===t);if(a===-1)return;const c={...this.products[a],...r,updatedAt:new Date().toISOString()};return this.products[a]=c,this.saveProducts(),c}deleteProduct(t){const r=this.products.length;return this.products=this.products.filter(a=>a.id!==t),this.products.length<r?(this.saveProducts(),!0):!1}}const f=new A,$=()=>{const{isDark:i}=E(),[t,r]=h.useState([]),[a,c]=h.useState("all"),[o,n]=h.useState([]),[x,R]=h.useState(!1),[g,b]=h.useState(0),[p,N]=h.useState(""),[S,v]=h.useState([]);h.useEffect(()=>{localStorage.removeItem("SECURE_PRODUCTS");const s=f.getAllProducts(),d=f.getUserExchangeRecords("current-user"),l=m.getCurrentPoints();r(s),v(s),n(d),b(l)},[]),h.useEffect(()=>{let s=[...t];if(a!=="all"&&(s=s.filter(d=>d.category===a)),p){const d=p.toLowerCase();s=s.filter(l=>l.name.toLowerCase().includes(d)||l.description.toLowerCase().includes(d)||l.tags.some(y=>y.toLowerCase().includes(d)))}v(s)},[a,p,t]);const j=s=>{try{const d=f.exchangeProduct(s.id,"current-user");n([d,...o]),b(m.getCurrentPoints()),r(t.map(l=>l.id===s.id?{...l,stock:l.stock-1}:l)),alert(`兑换成功！消耗${s.points}积分`)}catch(d){alert(d.message)}},P=[{value:"all",label:"全部"},{value:"virtual",label:"虚拟商品"},{value:"physical",label:"实物商品"},{value:"service",label:"服务"},{value:"rights",label:"权益"}];return e.jsx("div",{className:`min-h-screen ${i?"bg-gray-900 text-white":"bg-white text-gray-900"}`,children:e.jsxs("main",{className:"container mx-auto px-4 py-10",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"积分商城"}),e.jsxs("div",{className:`${i?"bg-gray-800":"bg-white"} rounded-full px-4 py-2 shadow-md`,children:[e.jsx("span",{className:"font-medium",children:"当前积分："}),e.jsx("span",{className:`ml-2 font-bold ${i?"text-red-400":"text-red-500"}`,children:g})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"text",placeholder:"搜索商品...",className:`w-full px-4 py-2 rounded-lg border ${i?"bg-gray-800 border-gray-700":"bg-gray-100 border-gray-300"} focus:outline-none focus:ring-2 focus:ring-red-500`,value:p,onChange:s=>N(s.target.value)})}),e.jsx("div",{className:"flex flex-wrap gap-2",children:P.map(s=>e.jsx("button",{onClick:()=>c(s.value),className:`px-4 py-2 rounded-full text-sm font-medium transition-all ${a===s.value?i?"bg-red-600 text-white":"bg-red-500 text-white":i?"bg-gray-800 hover:bg-gray-700":"bg-white hover:bg-gray-100"}`,children:s.label},s.value))})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:S.map((s,d)=>e.jsxs(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3,delay:.05*d},className:`${i?"bg-gray-800":"bg-white"} rounded-xl shadow-md overflow-hidden`,children:[e.jsx("div",{className:"h-48 overflow-hidden",children:e.jsx("img",{src:s.imageUrl,alt:s.name,className:"w-full h-full object-cover transition-transform duration-300 hover:scale-105"})}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("h3",{className:"text-lg font-bold",children:s.name}),e.jsxs("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${i?"bg-red-900 bg-opacity-50":"bg-red-100"} text-red-500`,children:[s.points," 积分"]})]}),e.jsx("p",{className:`mb-4 text-sm ${i?"text-gray-400":"text-gray-600"}`,children:s.description}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:s.tags.map((l,y)=>e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${i?"bg-gray-700":"bg-gray-100"}`,children:l},y))}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:`text-sm ${i?"text-gray-400":"text-gray-600"}`,children:["库存：",s.stock]}),e.jsx("button",{onClick:()=>j(s),disabled:s.status!=="active"||s.stock<=0||g<s.points,className:`px-4 py-2 rounded-lg font-medium transition-colors ${i?g<s.points||s.stock<=0?"bg-gray-700 cursor-not-allowed":"bg-red-600 hover:bg-red-700":g<s.points||s.stock<=0?"bg-gray-200 cursor-not-allowed":"bg-red-500 hover:bg-red-600"} text-white disabled:opacity-50`,children:s.stock<=0?"已售罄":g<s.points?"积分不足":"立即兑换"})]})]})]},s.id))}),S.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("svg",{className:"w-16 h-16 mx-auto mb-4 opacity-50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"未找到商品"}),e.jsx("p",{className:"opacity-70",children:"请尝试调整搜索条件或分类"})]}),e.jsxs("div",{className:"mt-12",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"兑换记录"}),e.jsx("button",{onClick:()=>R(!x),className:`px-3 py-1 rounded-full text-sm font-medium ${i?"bg-gray-800 hover:bg-gray-700":"bg-gray-100 hover:bg-gray-200"}`,children:x?"隐藏":"查看"})]}),x&&e.jsx(w.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:`${i?"bg-gray-800":"bg-white"} rounded-xl shadow-md overflow-hidden`,children:o.length===0?e.jsx("div",{className:"p-6 text-center",children:e.jsx("p",{className:"opacity-70",children:"暂无兑换记录"})}):e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:`${i?"border-b border-gray-700":"border-b border-gray-200"}`,children:[e.jsx("th",{className:"text-left p-4 text-sm font-medium ${isDark ? 'text-gray-400' : 'text-gray-600'}",children:"商品名称"}),e.jsx("th",{className:"text-left p-4 text-sm font-medium ${isDark ? 'text-gray-400' : 'text-gray-600'}",children:"积分"}),e.jsx("th",{className:"text-left p-4 text-sm font-medium ${isDark ? 'text-gray-400' : 'text-gray-600'}",children:"日期"}),e.jsx("th",{className:"text-left p-4 text-sm font-medium ${isDark ? 'text-gray-400' : 'text-gray-600'}",children:"状态"})]})}),e.jsx("tbody",{children:o.map(s=>e.jsxs("tr",{className:`${i?"border-b border-gray-700":"border-b border-gray-200"}`,children:[e.jsx("td",{className:"p-4",children:s.productName}),e.jsx("td",{className:"p-4",children:s.points}),e.jsx("td",{className:"p-4 text-sm opacity-70",children:s.date}),e.jsx("td",{className:"p-4",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${s.status==="completed"?"bg-green-500 text-white":s.status==="pending"?"bg-yellow-500 text-white":"bg-red-500 text-white"}`,children:s.status==="completed"?"已完成":s.status==="pending"?"处理中":"已取消"})})]},s.id))})]})})]})]})})};export{$ as default};
